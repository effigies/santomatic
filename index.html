<!DOCTYPE html>
<html>
  <head>
    <title>Secret Santa-o-matic</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.18.1/full/pyodide.js"></script>
    <script type="text/javascript">
      async function startup(){
        // Loading files can be asynchronous
        load_yaml = fetch("example.yml")
          .then( r => r.text() )
          .then( t => document.getElementById("yaml").value = t );
        read_python = fetch("lib.py").then( r => r.text() );

        // Python loading is order-sensitive
        let pyodide = await loadPyodide({
          indexURL : "https://cdn.jsdelivr.net/pyodide/v0.18.1/full/"
        });
        await pyodide.loadPackage(["pyyaml", "numpy", "networkx"]);
        await pyodide.runPython(await read_python);

        // Finalize and alert
        await load_yaml;
        document.getElementById("loading").textContent = "Ready!"
        return pyodide
      }
      pyodideReadyPromise = startup();

      async function load_yaml(){
        var file = document.getElementById("file").files[0];
        var reader = new FileReader();
        reader.readAsBinaryString(file);
        reader.onload = evt => {
          content = evt.target.result;
          yaml = document.getElementById("yaml");
          yaml.value = content;
          yaml.dispatchEvent(new Event("change"));
        }
      }

      async function validate(){
        let pyodide = await pyodideReadyPromise;
        pyodide.runPython(`
          import js
          import yaml
          textarea = js.document.getElementById("yaml")
          valid = js.document.getElementById("valid")
          try:
              config = yaml.safe_load(textarea.value)
              textarea.style.backgroundColor = "#ffffff";
              valid.textContent = "Valid!";
              valid.style.color = "green";
          except:
              textarea.style.backgroundColor = "#ffeeee";
              valid.textContent = "Invalid!";
              valid.style.color = "red";
        `);
      }
      validate();

      async function compute(){
        let pyodide = await pyodideReadyPromise;
        pyodide.runPython(`
          cycles = config['cycles']
          years = sorted(cycles, reverse=True)
          penalty = float(js.document.getElementById("penalty").value)
          selection = select(config['people'], nx.Graph(config['partners']),
                             (cycles[year] for year in years),
                             penalty)
          result = format_selection(selection, config['people'])
          js.document.getElementById("result").value = result
        `);
      }
    </script>
  </head>
  <body>
    <h1>Secret Santa-o-matic</h1>
    Enter a configuration: <span id="valid"></span>
    <div>
      <textarea id="yaml" rows=20 cols=80 onchange="validate();"></textarea>
    </div>
    <span>Load Santa config: <input type="file" onchange="load_yaml();" id="file"></span>

    <div>
      <form action="javascript:compute();">
      <label for="penalty">Enter penalty:</label>
      <input id="penalty" type="number" step="0.01" min="0" max="0.99" value="0.85">
      <button type="submit" id="button">Generate</button>
      </form>
      <span id="loading" style="color: green">Loading...</span>
    </div>
    <div>
      <textarea id="result" rows=20 cols=80 disabled></textarea>
    </div>
  </body>
</html>
